<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>스네이크 (캐릭터 버전)</title>
<style>
  :root{
    --bg:#0f172a;--grid:#1f2937;
    --snake:#22c55e;--head:#16a34a; --outline:#064e3b;
    --food:#ef4444; --food-leaf:#22c55e; --ui:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{
    margin:0;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:var(--bg);color:var(--ui);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  }
  h1{margin:0 0 .5rem;font-size:1.25rem;font-weight:700}
  #wrap{display:flex;flex-direction:column;align-items:center;gap:.75rem}
  canvas{background:var(--grid);border:2px solid #334155;border-radius:12px;image-rendering:pixelated}
  .hud{display:flex;gap:1rem;align-items:center;justify-content:center;flex-wrap:wrap}
  .btn{background:#334155;color:white;border:none;border-radius:10px;padding:.6rem 1rem;cursor:pointer;font-weight:700}
  .btn:active{transform:translateY(1px)}
  .pad{display:grid;grid-template-columns:repeat(3,56px);grid-template-rows:repeat(3,56px);gap:.4rem;margin-top:.2rem}
  .pad button{background:#1f2937;border:2px solid #334155;color:#cbd5e1;font-size:1rem;border-radius:10px}
  .muted{opacity:.7}
  @media (min-width:640px){ .pad{display:none} }
</style>
</head>
<body>
  <div id="wrap">
    <h1>스네이크 🐍</h1>
    <canvas id="game" width="420" height="420" aria-label="게임 캔버스"></canvas>
    <div class="hud">
      <div>점수: <strong id="score">0</strong></div>
      <div>최고: <strong id="best">0</strong></div>
      <button class="btn" id="toggle">시작</button>
      <button class="btn" id="restart">다시하기</button>
      <span class="muted">방향키 / WASD</span>
    </div>
    <div class="pad" aria-hidden="true">
      <span></span><button data-d="up">▲</button><span></span>
      <button data-d="left">◀</button><span></span><button data-d="right">▶</button>
      <span></span><button data-d="down">▼</button><span></span>
    </div>
  </div>

<script>
(() => {
  // ===== 기본 세팅 =====
  const cell = 20, cols = 20, rows = 20;
  const w = cols*cell, h = rows*cell;
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  cvs.width = w; cvs.height = h;

  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const toggleBtn = document.getElementById('toggle');
  const restartBtn= document.getElementById('restart');

  const bestKey = 'mini-snake-best';
  let best = Number(localStorage.getItem(bestKey) || 0);
  bestEl.textContent = best;

  // ===== 사운드 =====
  const AC = window.AudioContext || window.webkitAudioContext;
  let actx = null; function audio(){ if(!actx) actx = new AC(); }
  function beep({f=600,d=0.07,type='square',v=0.2}) {
    audio(); const t=actx.currentTime, o=actx.createOscillator(), g=actx.createGain();
    o.type=type; o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(v,t+0.005);
    g.gain.exponentialRampToValueAtTime(0.0001,t+d);
    o.connect(g).connect(actx.destination); o.start(t); o.stop(t+d);
  }
  const sTurn = ()=>beep({f:520,d:0.05,type:'triangle',v:0.15});
  const sEat  = ()=>{beep({f:440,d:0.06,type:'sine',v:0.22}); setTimeout(()=>beep({f:660,d:0.06,type:'sine',v:0.22}),55);};

  // ===== 상태 =====
  let snake, dir, pendingDir, food, score, speed, running, lastTime, acc;
  let tongueTimer = 0; // 혀 깜빡임

  function init(){
    snake=[{x:10,y:10}];
    dir={x:1,y:0}; pendingDir=dir;
    score=0; speed=8; running=false; lastTime=0; acc=0; tongueTimer=0;
    food=spawnFood(); scoreEl.textContent=score; draw();
  }
  function spawnFood(){
    while(true){
      const p={x:Math.floor(Math.random()*cols), y:Math.floor(Math.random()*rows)};
      if(!snake.some(s=>s.x===p.x&&s.y===p.y)) return p;
    }
  }

  // ===== 입력 =====
  const key2dir={ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1},ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0},
                 w:{x:0,y:-1},s:{x:0,y:1},a:{x:-1,y:0},d:{x:1,y:0}};
  addEventListener('keydown',e=>{
    const k=e.key; if(k in key2dir){
      const nd=key2dir[k];
      if(snake.length>1 && (nd.x===-dir.x && nd.y===-dir.y)) return;
      if(nd.x!==dir.x || nd.y!==dir.y) sTurn();
      pendingDir=nd; e.preventDefault();
    } else if(k===' '){ toggle(); }
  });
  document.querySelectorAll('.pad [data-d]').forEach(b=>{
    b.addEventListener('click',()=>{
      const map={up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0}};
      const nd=map[b.dataset.d];
      if(snake.length>1 && (nd.x===-dir.x && nd.y===-dir.y)) return;
      if(nd.x!==dir.x || nd.y!==dir.y) sTurn();
      pendingDir=nd;
    });
  });

  // ===== 루프 =====
  function loop(ts){
    if(!running) return;
    const dt=(ts-lastTime)/1000; lastTime=ts; acc+=dt; tongueTimer+=dt;
    const step=1/speed;
    while(acc>=step){ update(); acc-=step; }
    draw(); requestAnimationFrame(loop);
  }
  function update(){
    dir=pendingDir;
    const head={x:(snake[0].x+dir.x+cols)%cols, y:(snake[0].y+dir.y+rows)%rows};
    if(snake.some((s,i)=>i>0 && s.x===head.x&&s.y===head.y)){ gameOver(); return; }
    snake.unshift(head);
    if(head.x===food.x && head.y===food.y){
      score++; scoreEl.textContent=score; speed=Math.min(16,speed+0.3); sEat(); food=spawnFood();
    } else snake.pop();
  }

  // ===== 그리기 =====
  function draw(){
    // 배경
    ctx.fillStyle=getVar('--grid'); ctx.fillRect(0,0,w,h);
    // 은은한 점
    ctx.fillStyle='#111827';
    for(let y=0;y<rows;y++) for(let x=0;x<cols;x++) ctx.fillRect(x*cell,y*cell,1,1);

    // 먹이: 사과
    drawApple(food.x*cell, food.y*cell, cell);

    // 뱀
    for(let i=snake.length-1;i>=0;i--){
      const p=snake[i];
      if(i===0) drawHead(p, dir);           // 머리(눈·동공·혀)
      else drawBody(p, i, snake.length);    // 몸통(둥근 캡슐 느낌)
    }
  }

  function drawBody(p, idx, total){
    const x=p.x*cell, y=p.y*cell, r=cell*0.42;
    // 몸통 그라디언트
    const g=ctx.createRadialGradient(x+cell/2,y+cell/2, r*0.4, x+cell/2,y+cell/2, r);
    g.addColorStop(0,getVar('--head')); g.addColorStop(1,getVar('--snake'));
    ctx.fillStyle=g; ctx.beginPath();
    ctx.arc(x+cell/2,y+cell/2,r,0,Math.PI*2); ctx.fill();
    // 외곽선
    ctx.strokeStyle=getVar('--outline'); ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(x+cell/2,y+cell/2,r,0,Math.PI*2); ctx.stroke();
    // 비늘 점살짝
    ctx.fillStyle='rgba(255,255,255,0.08)';
    ctx.beginPath(); ctx.arc(x+cell/2+2,y+cell/2-2,2,0,Math.PI*2); ctx.fill();
  }

  function drawHead(p, dir){
    const x=p.x*cell, y=p.y*cell, r=cell*0.46;
    // 머리(그라디언트)
    const g=ctx.createRadialGradient(x+cell/2-2*dir.x, y+cell/2-2*dir.y, r*0.35, x+cell/2, y+cell/2, r);
    g.addColorStop(0,getVar('--head')); g.addColorStop(1,getVar('--snake'));
    ctx.fillStyle=g; ctx.beginPath();
    ctx.arc(x+cell/2,y+cell/2,r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=getVar('--outline'); ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(x+cell/2,y+cell/2,r,0,Math.PI*2); ctx.stroke();

    // 눈 위치(진행 방향 기준으로 좌/우 살짝 벌려서)
    const eyeOffset = 5, eyeSide = 6;
    const ex1 = x+cell/2 + (-dir.y)*eyeSide + dir.x*eyeOffset;
    const ey1 = y+cell/2 + ( dir.x)*eyeSide + dir.y*eyeOffset;
    const ex2 = x+cell/2 + ( dir.y)*eyeSide + dir.x*eyeOffset;
    const ey2 = y+cell/2 + (-dir.x)*eyeSide + dir.y*eyeOffset;

    // 흰자
    ctx.fillStyle='white';
    ctx.beginPath(); ctx.arc(ex1,ey1,4,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(ex2,ey2,4,0,Math.PI*2); ctx.fill();

    // 동공(방향쪽으로 살짝 치우치게)
    const pupilShift = 1.8;
    ctx.fillStyle='#111827';
    ctx.beginPath(); ctx.arc(ex1+dir.x*pupilShift, ey1+dir.y*pupilShift, 2, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(ex2+dir.x*pupilShift, ey2+dir.y*pupilShift, 2, 0, Math.PI*2); ctx.fill();

    // 혀(깜빡임): 0.2초마다 잠깐 튀어나왔다 들어감
    const showTongue = (Math.floor(tongueTimer*5)%5===0); // 1/5 확률 프레임
    if(showTongue){
      const tx = x+cell/2 + dir.x*(r+2);
      const ty = y+cell/2 + dir.y*(r+2);
      ctx.strokeStyle='#dc2626'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(tx,ty);
      ctx.lineTo(tx+dir.x*6, ty+dir.y*6); ctx.stroke();
      // 혀 끝 갈라짐
      ctx.beginPath();
      ctx.moveTo(tx+dir.x*6, ty+dir.y*6);
      ctx.lineTo(tx+dir.x*8 + (dir.y*2), ty+dir.y*8 + (-dir.x*2));
      ctx.moveTo(tx+dir.x*6, ty+dir.y*6);
      ctx.lineTo(tx+dir.x*8 + (-dir.y*2), ty+dir.y*8 + ( dir.x*2));
      ctx.stroke();
    }
  }

  function drawApple(px, py, size){
    const cx=px+size/2, cy=py+size/2, r=size*0.35;
    // 본체
    ctx.fillStyle=getVar('--food');
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
    // 하이라이트
    ctx.fillStyle='rgba(255,255,255,0.25)';
    ctx.beginPath(); ctx.arc(cx-4,cy-4, r*0.5, 0, Math.PI*2); ctx.fill();
    // 줄기
    ctx.strokeStyle='#78350f'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(cx,cy-r); ctx.lineTo(cx+2,cy-r-6); ctx.stroke();
    // 잎
    ctx.fillStyle=getVar('--food-leaf');
    ctx.beginPath();
    ctx.ellipse(cx+4, cy-r-6, 3, 5, -0.5, 0, Math.PI*2);
    ctx.fill();
  }

  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  // ===== 컨트롤 =====
  function toggle(){ running=!running; toggleBtn.textContent=running?'일시정지':'시작';
    if(running){ audio(); lastTime=performance.now(); requestAnimationFrame(loop); } }
  function gameOver(){
    running=false; toggleBtn.textContent='시작';
    best=Math.max(best,score); localStorage.setItem(bestKey,best); bestEl.textContent=best;
    alert(`게임 오버! 점수: ${score}`);
  }
  toggleBtn.addEventListener('click',toggle);
  restartBtn.addEventListener('click',()=>init());
  init();
})();
</script>
</body>
</html>
