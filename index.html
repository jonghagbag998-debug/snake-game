<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>스네이크 (미니)</title>
<style>
  :root{--bg:#0f172a;--grid:#1f2937;--snake:#22c55e;--head:#16a34a;--food:#f97316;--ui:#e5e7eb;}
  *{box-sizing:border-box} body{
    margin:0; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:var(--bg); color:var(--ui); font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  h1{margin:0 0 .5rem; font-size:1.25rem; font-weight:700}
  #wrap{display:flex; flex-direction:column; align-items:center; gap:.75rem}
  canvas{background:var(--grid); border:2px solid #334155; border-radius:12px; image-rendering:pixelated}
  .hud{display:flex; gap:1rem; align-items:center; justify-content:center; flex-wrap:wrap}
  .btn{background:#334155; color:white; border:none; border-radius:10px; padding:.6rem 1rem; cursor:pointer; font-weight:700}
  .btn:active{transform:translateY(1px)}
  .pad{display:grid; grid-template-columns:repeat(3,56px); grid-template-rows:repeat(3,56px); gap:.4rem; margin-top:.2rem}
  .pad button{background:#1f2937; border:2px solid #334155; color:#cbd5e1; font-size:1rem; border-radius:10px}
  .muted{opacity:.7}
  @media (min-width:640px){ .pad{display:none} } /* 데스크탑에선 터치패드 숨김 */
</style>
</head>
<body>
  <div id="wrap">
    <h1>스네이크 (미니)</h1>
    <canvas id="game" width="420" height="420" aria-label="게임 캔버스"></canvas>
    <div class="hud">
      <div>점수: <strong id="score">0</strong></div>
      <div>최고: <strong id="best">0</strong></div>
      <button class="btn" id="toggle">시작</button>
      <button class="btn" id="restart">다시하기</button>
      <span class="muted">방향키 / WASD</span>
    </div>

    <!-- 모바일 방향패드 -->
    <div class="pad" aria-hidden="true">
      <span></span><button data-d="up">▲</button><span></span>
      <button data-d="left">◀</button><span></span><button data-d="right">▶</button>
      <span></span><button data-d="down">▼</button><span></span>
    </div>
  </div>

<script>
(() => {
  // --- 기본 설정 ---
  const cell = 20;                 // 한 칸 크기(px)
  const cols = 20, rows = 20;      // 20x20 그리드
  const w = cols * cell, h = rows * cell;

  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  cvs.width = w; cvs.height = h;

  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const toggleBtn = document.getElementById('toggle');
  const restartBtn = document.getElementById('restart');

  const bestKey = 'mini-snake-best';
  let best = Number(localStorage.getItem(bestKey) || 0);
  bestEl.textContent = best;

  // 게임 상태
  let snake, dir, pendingDir, food, score, speed, running, lastTime, acc;

  function init() {
    snake = [{x:10, y:10}];      // 머리 위치
    dir = {x:1, y:0};            // 초기 방향(오른쪽)
    pendingDir = dir;
    score = 0; speed = 8;        // 초당 스텝
    acc = 0; lastTime = 0; running = false;
    food = spawnFood();
    scoreEl.textContent = score;
    draw();                       // 초기 화면
  }

  function spawnFood() {
    while (true) {
      const p = {x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows)};
      if (!snake.some(s => s.x===p.x && s.y===p.y)) return p;
    }
  }

  // --- 입력 처리 ---
  const keys = {
    ArrowUp: {x:0,y:-1}, ArrowDown:{x:0,y:1}, ArrowLeft:{x:-1,y:0}, ArrowRight:{x:1,y:0},
    w:{x:0,y:-1}, s:{x:0,y:1}, a:{x:-1,y:0}, d:{x:1,y:0}
  };
  addEventListener('keydown', e => {
    const k = e.key;
    if (k in keys) {
      const nd = keys[k];
      // 반대 방향 즉시 금지
      if (snake.length > 1 && (nd.x === -dir.x && nd.y === -dir.y)) return;
      pendingDir = nd;
      e.preventDefault();
    } else if (k === ' '){ toggle(); }
  });

  // 모바일 패드
  document.querySelectorAll('.pad [data-d]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.d;
      const map={up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0}};
      const nd = map[d];
      if (snake.length > 1 && (nd.x === -dir.x && nd.y === -dir.y)) return;
      pendingDir = nd;
    });
  });

  // --- 루프 ---
  function loop(ts) {
    if (!running) return;
    const dt = (ts - lastTime) / 1000; // 초
    lastTime = ts;
    acc += dt;
    const step = 1 / speed;
    while (acc >= step) { update(); acc -= step; }
    draw();
    requestAnimationFrame(loop);
  }

  function update() {
    dir = pendingDir;
    const head = {x: (snake[0].x + dir.x + cols) % cols, y: (snake[0].y + dir.y + rows) % rows}; // 벽 통과(도넛맵)
    // 몸 충돌 체크
    if (snake.some((s,i)=> i>0 && s.x===head.x && s.y===head.y)) {
      gameOver(); return;
    }
    snake.unshift(head);

    // 먹이
    if (head.x === food.x && head.y === food.y) {
      score++; scoreEl.textContent = score;
      speed = Math.min(16, speed + 0.3); // 조금씩 빨라짐
      food = spawnFood();
    } else {
      snake.pop(); // 이동만
    }
  }

  // --- 그리기 ---
  function draw() {
    // 배경
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid');
    ctx.fillRect(0,0,w,h);

    // 그리드 은은한 점
    ctx.fillStyle = '#111827';
    for (let y=0; y<rows; y++) for (let x=0; x<cols; x++) {
      ctx.fillRect(x*cell, y*cell, 1, 1);
    }
    // 먹이
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--food');
    roundRect(food.x*cell+2, food.y*cell+2, cell-4, cell-4, 5, true);

    // 뱀
    snake.forEach((p,i)=>{
      ctx.fillStyle = i===0
        ? getComputedStyle(document.documentElement).getPropertyValue('--head')
        : getComputedStyle(document.documentElement).getPropertyValue('--snake');
      roundRect(p.x*cell+1.5, p.y*cell+1.5, cell-3, cell-3, 6, true);
    });
  }

  function roundRect(x,y,w,h,r,fill){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    fill?ctx.fill():ctx.stroke();
  }

  // --- 컨트롤 ---
  function toggle(){
    running = !running;
    toggleBtn.textContent = running ? '일시정지' : '시작';
    if (running){ lastTime = performance.now(); requestAnimationFrame(loop); }
  }
  function gameOver(){
    running = false; toggleBtn.textContent = '시작';
    best = Math.max(best, score); localStorage.setItem(bestKey, best); bestEl.textContent = best;
    alert(`게임 오버! 점수: ${score}`);
  }

  toggleBtn.addEventListener('click', toggle);
  restartBtn.addEventListener('click', ()=>{ init(); });
  init();
})();
</script>
</body>
</html>
