<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>스네이크 (다이아몬드+사운드)</title>
<style>
  :root{
    --bg:#0f172a;--grid:#1f2937;
    --snake:#22c55e;--head:#16a34a;
    --food:#ef4444; /* 빨간 먹이 */
    --ui:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{
    margin:0;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:var(--bg);color:var(--ui);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  }
  h1{margin:0 0 .5rem;font-size:1.25rem;font-weight:700}
  #wrap{display:flex;flex-direction:column;align-items:center;gap:.75rem}
  canvas{background:var(--grid);border:2px solid #334155;border-radius:12px;image-rendering:pixelated}
  .hud{display:flex;gap:1rem;align-items:center;justify-content:center;flex-wrap:wrap}
  .btn{background:#334155;color:white;border:none;border-radius:10px;padding:.6rem 1rem;cursor:pointer;font-weight:700}
  .btn:active{transform:translateY(1px)}
  .pad{display:grid;grid-template-columns:repeat(3,56px);grid-template-rows:repeat(3,56px);gap:.4rem;margin-top:.2rem}
  .pad button{background:#1f2937;border:2px solid #334155;color:#cbd5e1;font-size:1rem;border-radius:10px}
  .muted{opacity:.7}
  @media (min-width:640px){ .pad{display:none} } /* 데스크탑에선 터치패드 숨김 */
</style>
</head>
<body>
  <div id="wrap">
    <h1>스네이크 (다이아몬드)</h1>
    <canvas id="game" width="420" height="420" aria-label="게임 캔버스"></canvas>
    <div class="hud">
      <div>점수: <strong id="score">0</strong></div>
      <div>최고: <strong id="best">0</strong></div>
      <button class="btn" id="toggle">시작</button>
      <button class="btn" id="restart">다시하기</button>
      <span class="muted">방향키 / WASD</span>
    </div>

    <!-- 모바일 방향패드 -->
    <div class="pad" aria-hidden="true">
      <span></span><button data-d="up">▲</button><span></span>
      <button data-d="left">◀</button><span></span><button data-d="right">▶</button>
      <span></span><button data-d="down">▼</button><span></span>
    </div>
  </div>

<script>
(() => {
  // --- 기본 설정 ---
  const cell = 20;                 // 한 칸 크기(px)
  const cols = 20, rows = 20;      // 20x20 그리드
  const w = cols * cell, h = rows * cell;

  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  cvs.width = w; cvs.height = h;

  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const toggleBtn = document.getElementById('toggle');
  const restartBtn = document.getElementById('restart');

  const bestKey = 'mini-snake-best';
  let best = Number(localStorage.getItem(bestKey) || 0);
  bestEl.textContent = best;

  // --- 사운드(웹오디오, 외부파일 없이 생성) ---
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let actx = null;
  function ensureAudio() { if (!actx) actx = new AudioCtx(); }
  function beep({freq=600, dur=0.07, type='square', vol=0.2}) {
    ensureAudio();
    const t0 = actx.currentTime;
    const osc = actx.createOscillator();
    const gain = actx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, t0);
    gain.gain.setValueAtTime(0, t0);
    gain.gain.linearRampToValueAtTime(vol, t0 + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    osc.connect(gain).connect(actx.destination);
    osc.start(t0); osc.stop(t0 + dur);
  }
  const playTurn = () => beep({freq:520, dur:0.05, type:'triangle', vol:0.15});
  const playEat  = () => { // 짧은 두음
    beep({freq:440, dur:0.06, type:'sine', vol:0.22});
    setTimeout(()=>beep({freq:660, dur:0.06, type:'sine', vol:0.22}), 55);
  };

  // 게임 상태
  let snake, dir, pendingDir, food, score, speed, running, lastTime, acc;

  function init() {
    snake = [{x:10, y:10}];      // 머리 위치
    dir = {x:1, y:0};            // 초기 방향(오른쪽)
    pendingDir = dir;
    score = 0; speed = 8;        // 초당 스텝
    acc = 0; lastTime = 0; running = false;
    food = spawnFood();
    scoreEl.textContent = score;
    draw();                       // 초기 화면
  }

  function spawnFood() {
    while (true) {
      const p = {x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows)};
      if (!snake.some(s => s.x===p.x && s.y===p.y)) return p;
    }
  }

  // --- 입력 처리 ---
  const keys = {
    ArrowUp: {x:0,y:-1}, ArrowDown:{x:0,y:1}, ArrowLeft:{x:-1,y:0}, ArrowRight:{x:1,y:0},
    w:{x:0,y:-1}, s:{x:0,y:1}, a:{x:-1,y:0}, d:{x:1,y:0}
  };
  addEventListener('keydown', e => {
    const k = e.key;
    if (k in keys) {
      const nd = keys[k];
      // 반대 방향 즉시 금지
      if (snake.length > 1 && (nd.x === -dir.x && nd.y === -dir.y)) return;
      // 현재 진행방향과 다른 방향으로 바꿀 때만 효과음
      if (nd.x !== dir.x || nd.y !== dir.y) playTurn();
      pendingDir = nd;
      e.preventDefault();
    } else if (k === ' '){ toggle(); }
  });

  // 모바일 패드
  document.querySelectorAll('.pad [data-d]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.d;
      const map={up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0}};
      const nd = map[d];
      if (snake.length > 1 && (nd.x === -dir.x && nd.y === -dir.y)) return;
      if (nd.x !== dir.x || nd.y !== dir.y) playTurn();
      pendingDir = nd;
    });
  });

  // --- 루프 ---
  function loop(ts) {
    if (!running) return;
    const dt = (ts - lastTime) / 1000; // 초
    lastTime = ts;
    acc += dt;
    const step = 1 / speed;
    while (acc >= step) { update(); acc -= step; }
    draw();
    requestAnimationFrame(loop);
  }

  function update() {
    dir = pendingDir;
    const head = {x: (snake[0].x + dir.x + cols) % cols, y: (snake[0].y + dir.y + rows) % rows}; // 벽 통과(도넛맵)
    // 몸 충돌 체크
    if (snake.some((s,i)=> i>0 && s.x===head.x && s.y===head.y)) {
      gameOver(); return;
    }
    snake.unshift(head);

    // 먹이
    if (head.x === food.x && head.y === food.y) {
      score++; scoreEl.textContent = score;
      speed = Math.min(16, speed + 0.3); // 조금씩 빨라짐
      playEat();
      food = spawnFood();
    } else {
      snake.pop(); // 이동만
    }
  }

  // --- 그리기 ---
  function draw() {
    // 배경
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid');
    ctx.fillRect(0,0,w,h);

    // 은은한 점 그리드
    ctx.fillStyle = '#111827';
    for (let y=0; y<rows; y++) for (let x=0; x<cols; x++) {
      ctx.fillRect(x*cell, y*cell, 1, 1);
    }

    // 먹이(다이아몬드)
    drawDiamond(food.x*cell, food.y*cell, cell, getComputedStyle(document.documentElement).getPropertyValue('--food'));

    // 뱀: 머리/몸 다이아몬드
    snake.forEach((p,i)=>{
      const color = i===0
        ? getComputedStyle(document.documentElement).getPropertyValue('--head')
        : getComputedStyle(document.documentElement).getPropertyValue('--snake');
      drawDiamond(p.x*cell, p.y*cell, cell, color);
    });
  }

  // 다이아몬드(마름모) 그리기: 셀 중앙 기준 4점 연결
  function drawDiamond(px, py, size, fillStyle){
    const half = size/2, cx = px + half, cy = py + half;
    ctx.fillStyle = fillStyle;
    ctx.beginPath();
    ctx.moveTo(cx, cy - half + 2);     // 위
    ctx.lineTo(cx + half - 2, cy);     // 오른쪽
    ctx.lineTo(cx, cy + half - 2);     // 아래
    ctx.lineTo(cx - half - 2 + size, cy); // 왼쪽(테두리 살짝 여백)
    ctx.closePath();
    ctx.fill();
  }

  // --- 컨트롤 ---
  function toggle(){
    running = !running;
    toggleBtn.textContent = running ? '일시정지' : '시작';
    if (running){ ensureAudio(); lastTime = performance.now(); requestAnimationFrame(loop); }
  }
  function gameOver(){
    running = false; toggleBtn.textContent = '시작';
    best = Math.max(best, score); localStorage.setItem(bestKey, best); bestEl.textContent = best;
    alert(`게임 오버! 점수: ${score}`);
  }

  toggleBtn.addEventListener('click', toggle);
  restartBtn.addEventListener('click', ()=>{ init(); });
  init();
})();
</script>
</body>
</html>
